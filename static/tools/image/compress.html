<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="åœ¨çº¿å›¾ç‰‡å‹ç¼©å·¥å…· - æ”¯æŒæŒ‰è´¨é‡ã€æŒ‰æ–‡ä»¶å¤§å°ã€æŒ‰å®½é«˜ä¸‰ç§å‹ç¼©æ¨¡å¼">
  <title>å›¾ç‰‡å‹ç¼© - åœ¨çº¿å·¥å…·</title>
  <link rel="canonical" href="/static/tools/image/compress.html">
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  <nav class="nav">
    <div class="container nav-content">
      <a href="/" class="nav-logo">ğŸ› ï¸ åœ¨çº¿å·¥å…·</a>
    </div>
  </nav>

  <div class="tool-page">
    <header class="page-header">
      <h1>å›¾ç‰‡å‹ç¼©</h1>
      <p>æ”¯æŒæŒ‰è´¨é‡ã€æŒ‰æ–‡ä»¶å¤§å°ã€æŒ‰å®½é«˜ä¸‰ç§å‹ç¼©æ¨¡å¼</p>
    </header>

    <div class="tool-box">
      <div id="uploadArea" class="upload-area">
        <input type="file" accept="image/*">
        <div class="upload-icon">ğŸ“·</div>
        <p class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</p>
        <p id="fileInfo" style="margin-top:0.5rem;color:#3b82f6"></p>
      </div>

      <!-- å‹ç¼©æ¨¡å¼é€‰æ‹© -->
      <div class="form-group" style="margin-top:1.5rem">
        <label>å‹ç¼©æ¨¡å¼</label>
        <div style="display:flex;gap:1rem;margin-top:0.5rem">
          <label style="display:flex;align-items:center;gap:0.3rem;cursor:pointer">
            <input type="radio" name="mode" value="quality" checked onchange="switchMode('quality')"> æŒ‰è´¨é‡
          </label>
          <label style="display:flex;align-items:center;gap:0.3rem;cursor:pointer">
            <input type="radio" name="mode" value="size" onchange="switchMode('size')"> æŒ‰æ–‡ä»¶å¤§å°
          </label>
          <label style="display:flex;align-items:center;gap:0.3rem;cursor:pointer">
            <input type="radio" name="mode" value="dimensions" onchange="switchMode('dimensions')"> æŒ‰å®½é«˜
          </label>
        </div>
      </div>

      <!-- æŒ‰è´¨é‡å‹ç¼© -->
      <div id="qualityMode" class="mode-panel">
        <div class="form-group">
          <label for="quality">å‹ç¼©è´¨é‡: <span id="qualityValue">80</span>%</label>
          <input type="range" id="quality" min="10" max="100" value="80" 
                 oninput="document.getElementById('qualityValue').textContent=this.value">
        </div>
      </div>

      <!-- æŒ‰æ–‡ä»¶å¤§å°å‹ç¼© -->
      <div id="sizeMode" class="mode-panel" style="display:none">
        <div class="form-group">
          <label for="targetSize">ç›®æ ‡æ–‡ä»¶å¤§å° (KB)</label>
          <input type="number" id="targetSize" class="form-input" value="100" min="1">
        </div>
      </div>

      <!-- æŒ‰å®½é«˜å‹ç¼© -->
      <div id="dimensionsMode" class="mode-panel" style="display:none">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
          <div class="form-group">
            <label for="maxWidth">æœ€å¤§å®½åº¦ (px)</label>
            <input type="number" id="maxWidth" class="form-input" placeholder="ç•™ç©ºä¸é™åˆ¶" min="1">
          </div>
          <div class="form-group">
            <label for="maxHeight">æœ€å¤§é«˜åº¦ (px)</label>
            <input type="number" id="maxHeight" class="form-input" placeholder="ç•™ç©ºä¸é™åˆ¶" min="1">
          </div>
        </div>
        <div class="form-group">
          <label for="dimQuality">è¾“å‡ºè´¨é‡: <span id="dimQualityValue">85</span>%</label>
          <input type="range" id="dimQuality" min="10" max="100" value="85" 
                 oninput="document.getElementById('dimQualityValue').textContent=this.value">
        </div>
      </div>

      <button id="compressBtn" class="btn btn-primary btn-block" onclick="compressImage()" disabled>
        å‹ç¼©å›¾ç‰‡
      </button>
      <div id="compressBtn-loading" class="loading"><span class="spinner"></span> å‹ç¼©ä¸­...</div>

      <div id="result" class="result-area"></div>
    </div>
  </div>

  <script src="/static/js/common.js"></script>
  <script>
    let fileId = null;
    let currentMode = 'quality';
    
    function switchMode(mode) {
      currentMode = mode;
      document.getElementById('qualityMode').style.display = mode === 'quality' ? 'block' : 'none';
      document.getElementById('sizeMode').style.display = mode === 'size' ? 'block' : 'none';
      document.getElementById('dimensionsMode').style.display = mode === 'dimensions' ? 'block' : 'none';
    }
    
    const uploader = new FileUploader('uploadArea', {
      onFileSelect: async (files) => {
        const file = files[0];
        document.getElementById('fileInfo').textContent = 
          `${file.name} (${formatFileSize(file.size)})`;
        
        const result = await uploadFile(file, '/image/upload');
        if (result.success) {
          fileId = result.file_id;
          document.getElementById('compressBtn').disabled = false;
        } else {
          showResult('result', false, result.error_message || 'ä¸Šä¼ å¤±è´¥');
        }
      }
    });
    
    async function compressImage() {
      if (!fileId) return;
      
      setLoading('compressBtn', true);
      let result;
      
      if (currentMode === 'quality') {
        const quality = parseInt(document.getElementById('quality').value);
        result = await apiRequest('/image/compress', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ file_id: fileId, quality })
        });
      } else if (currentMode === 'size') {
        const targetSize = parseInt(document.getElementById('targetSize').value);
        result = await apiRequest('/image/compress-to-size', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ file_id: fileId, target_size_kb: targetSize })
        });
      } else {
        const maxWidth = document.getElementById('maxWidth').value;
        const maxHeight = document.getElementById('maxHeight').value;
        const quality = parseInt(document.getElementById('dimQuality').value);
        
        if (!maxWidth && !maxHeight) {
          setLoading('compressBtn', false);
          showResult('result', false, 'è¯·è‡³å°‘æŒ‡å®šæœ€å¤§å®½åº¦æˆ–æœ€å¤§é«˜åº¦');
          return;
        }
        
        result = await apiRequest('/image/compress-to-dimensions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            file_id: fileId, 
            max_width: maxWidth ? parseInt(maxWidth) : null,
            max_height: maxHeight ? parseInt(maxHeight) : null,
            quality 
          })
        });
      }
      
      setLoading('compressBtn', false);
      
      if (result.success) {
        showResult('result', true, 
          `å‹ç¼©æˆåŠŸï¼<a href="${result.download_url}" download>ç‚¹å‡»ä¸‹è½½</a>`);
      } else {
        showResult('result', false, result.error_message || 'å‹ç¼©å¤±è´¥');
      }
    }
  </script>
</body>
</html>
