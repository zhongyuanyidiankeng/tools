<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="åœ¨çº¿Cronè¡¨è¾¾å¼ç”Ÿæˆå™¨">
  <title>Cron ç”Ÿæˆå™¨ - åœ¨çº¿å·¥å…·</title>
  <link rel="canonical" href="/static/tools/dev/cron-generate.html">
  <link rel="stylesheet" href="/static/css/style.css">
  <style>
    .cron-presets { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
    .cron-presets button { font-size: 0.875rem; padding: 0.4rem 0.8rem; }
    .field-type { margin-top: 0.5rem; }
    .field-type select { width: 100%; padding: 0.4rem; border: 1px solid #e2e8f0; border-radius: 4px; }
    .next-runs { margin-top: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px; }
    .next-runs h4 { margin: 0 0 0.5rem 0; color: #475569; font-size: 0.9rem; }
    .next-runs ul { margin: 0; padding-left: 1.5rem; }
    .next-runs li { color: #64748b; font-family: monospace; margin: 0.3rem 0; }
    .cron-help { font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem; }
  </style>
</head>
<body>
  <nav class="nav"><div class="container nav-content"><a href="/" class="nav-logo">ğŸ› ï¸ åœ¨çº¿å·¥å…·</a></div></nav>
  <div class="tool-page">
    <header class="page-header"><h1>Cron è¡¨è¾¾å¼ç”Ÿæˆå™¨</h1><p>å¯è§†åŒ–ç”Ÿæˆ Cron è¡¨è¾¾å¼ï¼Œæ”¯æŒå¤šç§åŒ¹é…æ¨¡å¼</p></header>
    <div class="tool-box">
      <!-- å¿«æ·é¢„è®¾ -->
      <div class="form-group">
        <label>å¿«æ·é¢„è®¾</label>
        <div class="cron-presets">
          <button class="btn" onclick="setPreset('0 * * * *')">æ¯å°æ—¶</button>
          <button class="btn" onclick="setPreset('0 0 * * *')">æ¯å¤©0ç‚¹</button>
          <button class="btn" onclick="setPreset('0 8 * * *')">æ¯å¤©8ç‚¹</button>
          <button class="btn" onclick="setPreset('0 0 * * 1')">æ¯å‘¨ä¸€</button>
          <button class="btn" onclick="setPreset('0 0 1 * *')">æ¯æœˆ1å·</button>
          <button class="btn" onclick="setPreset('*/5 * * * *')">æ¯5åˆ†é’Ÿ</button>
          <button class="btn" onclick="setPreset('0 */2 * * *')">æ¯2å°æ—¶</button>
          <button class="btn" onclick="setPreset('30 4 * * *')">æ¯å¤©4:30</button>
        </div>
      </div>

      <!-- Cron å­—æ®µ -->
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:1rem">
        <div class="form-group">
          <label>åˆ†é’Ÿ (0-59)</label>
          <div class="field-type">
            <select id="minute_type" onchange="updateFieldInput('minute')">
              <option value="*">æ¯åˆ†é’Ÿ (*)</option>
              <option value="specific" selected>æŒ‡å®šå€¼</option>
              <option value="range">èŒƒå›´ (x-y)</option>
              <option value="step">é—´éš” (*/n)</option>
              <option value="list">åˆ—è¡¨ (x,y,z)</option>
            </select>
          </div>
          <input type="text" id="minute" class="form-input" value="0" style="margin-top:0.5rem">
          <div class="cron-help">0-59</div>
        </div>
        <div class="form-group">
          <label>å°æ—¶ (0-23)</label>
          <div class="field-type">
            <select id="hour_type" onchange="updateFieldInput('hour')">
              <option value="*" selected>æ¯å°æ—¶ (*)</option>
              <option value="specific">æŒ‡å®šå€¼</option>
              <option value="range">èŒƒå›´ (x-y)</option>
              <option value="step">é—´éš” (*/n)</option>
              <option value="list">åˆ—è¡¨ (x,y,z)</option>
            </select>
          </div>
          <input type="text" id="hour" class="form-input" value="*" style="margin-top:0.5rem">
          <div class="cron-help">0-23</div>
        </div>
        <div class="form-group">
          <label>æ—¥ (1-31)</label>
          <div class="field-type">
            <select id="day_type" onchange="updateFieldInput('day')">
              <option value="*" selected>æ¯å¤© (*)</option>
              <option value="specific">æŒ‡å®šå€¼</option>
              <option value="range">èŒƒå›´ (x-y)</option>
              <option value="step">é—´éš” (*/n)</option>
              <option value="list">åˆ—è¡¨ (x,y,z)</option>
            </select>
          </div>
          <input type="text" id="day" class="form-input" value="*" style="margin-top:0.5rem">
          <div class="cron-help">1-31</div>
        </div>
        <div class="form-group">
          <label>æœˆ (1-12)</label>
          <div class="field-type">
            <select id="month_type" onchange="updateFieldInput('month')">
              <option value="*" selected>æ¯æœˆ (*)</option>
              <option value="specific">æŒ‡å®šå€¼</option>
              <option value="range">èŒƒå›´ (x-y)</option>
              <option value="step">é—´éš” (*/n)</option>
              <option value="list">åˆ—è¡¨ (x,y,z)</option>
            </select>
          </div>
          <input type="text" id="month" class="form-input" value="*" style="margin-top:0.5rem">
          <div class="cron-help">1-12</div>
        </div>
        <div class="form-group">
          <label>æ˜ŸæœŸ (0-6)</label>
          <div class="field-type">
            <select id="weekday_type" onchange="updateFieldInput('weekday')">
              <option value="*" selected>æ¯å¤© (*)</option>
              <option value="specific">æŒ‡å®šå€¼</option>
              <option value="range">èŒƒå›´ (x-y)</option>
              <option value="list">åˆ—è¡¨ (x,y,z)</option>
            </select>
          </div>
          <input type="text" id="weekday" class="form-input" value="*" style="margin-top:0.5rem">
          <div class="cron-help">0=å‘¨æ—¥, 1-6=å‘¨ä¸€è‡³å‘¨å…­</div>
        </div>
      </div>

      <button class="btn btn-primary btn-block" onclick="generateCron()">ç”Ÿæˆå¹¶è®¡ç®—æ‰§è¡Œæ—¶é—´</button>
      <div id="result" class="result-area"></div>
      
      <div class="form-group" style="margin-top:1rem">
        <label>Cron è¡¨è¾¾å¼</label>
        <input type="text" id="expression" class="form-input" readonly style="font-family:monospace;font-size:1.2rem;text-align:center">
      </div>
      <div class="form-group"><label>æè¿°</label><p id="description" style="color:#475569"></p></div>
      
      <!-- æœ€è¿‘æ‰§è¡Œæ—¶é—´ -->
      <div id="nextRunsContainer" class="next-runs" style="display:none">
        <h4>ğŸ“… æœ€è¿‘ 5 æ¬¡æ‰§è¡Œæ—¶é—´</h4>
        <ul id="nextRunsList"></ul>
      </div>
    </div>
  </div>
  <script src="/static/js/common.js"></script>
  <script>
    function setPreset(expr) {
      const parts = expr.split(' ');
      document.getElementById('minute').value = parts[0];
      document.getElementById('hour').value = parts[1];
      document.getElementById('day').value = parts[2];
      document.getElementById('month').value = parts[3];
      document.getElementById('weekday').value = parts[4];
      // æ›´æ–°ç±»å‹é€‰æ‹©å™¨
      updateTypeSelector('minute', parts[0]);
      updateTypeSelector('hour', parts[1]);
      updateTypeSelector('day', parts[2]);
      updateTypeSelector('month', parts[3]);
      updateTypeSelector('weekday', parts[4]);
      generateCron();
    }
    
    function updateTypeSelector(field, value) {
      const select = document.getElementById(field + '_type');
      if (value === '*') select.value = '*';
      else if (value.includes('/')) select.value = 'step';
      else if (value.includes('-')) select.value = 'range';
      else if (value.includes(',')) select.value = 'list';
      else select.value = 'specific';
    }
    
    function updateFieldInput(field) {
      const type = document.getElementById(field + '_type').value;
      const input = document.getElementById(field);
      const defaults = { minute: '0', hour: '0', day: '1', month: '1', weekday: '0' };
      
      switch(type) {
        case '*': input.value = '*'; break;
        case 'specific': input.value = defaults[field]; break;
        case 'range': input.value = field === 'minute' ? '0-30' : field === 'hour' ? '9-17' : '1-15'; break;
        case 'step': input.value = field === 'minute' ? '*/5' : '*/2'; break;
        case 'list': input.value = field === 'weekday' ? '1,3,5' : '1,15'; break;
      }
    }
    
    async function generateCron() {
      const data = {
        minute: document.getElementById('minute').value,
        hour: document.getElementById('hour').value,
        day: document.getElementById('day').value,
        month: document.getElementById('month').value,
        weekday: document.getElementById('weekday').value
      };
      const result = await apiRequest('/dev/cron-generate', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      if (result.success) {
        document.getElementById('expression').value = result.expression;
        document.getElementById('description').textContent = result.description;
        showResult('result', true, 'ç”ŸæˆæˆåŠŸ');
        
        // æ˜¾ç¤ºæœ€è¿‘æ‰§è¡Œæ—¶é—´
        if (result.next_runs && result.next_runs.length > 0) {
          document.getElementById('nextRunsContainer').style.display = 'block';
          const list = document.getElementById('nextRunsList');
          list.innerHTML = result.next_runs.map(time => {
            const date = new Date(time);
            return `<li>${formatDateTime(date)}</li>`;
          }).join('');
        } else {
          document.getElementById('nextRunsContainer').style.display = 'none';
        }
      } else {
        showResult('result', false, result.error_message);
        document.getElementById('nextRunsContainer').style.display = 'none';
      }
    }
    
    function formatDateTime(date) {
      const pad = n => n.toString().padStart(2, '0');
      const weekdays = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
      return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())} (${weekdays[date.getDay()]})`;
    }
  </script>
</body>
</html>
